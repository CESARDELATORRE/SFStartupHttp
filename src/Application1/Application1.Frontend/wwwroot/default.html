<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Values List</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <style>
        .input-group {
            margin: 20px;
        }

        .btn {
            margin-left: 20px;
        }

        p {
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="row">
        <div class="col-lg-3">
            <div class="input-group">
                <span class="input-group-btn">
                    <button class="btn btn-default" onclick="startValuesEntity()" type="button">Start a new entity</button>
                </span>                
            </div>
            <h4>Id: <span class="label label-info" id="id"></span></h4>
            <div class="input-group">
                <input type="text" class="form-control" id="newValueContent" placeholder="Add new value ...">
                <span class="input-group-btn">
                    <button class="btn btn-default" onclick="addNewValue()" type="button">Add</button>
                </span>
            </div>
            <div class="input-group">
                <ul class="list-group" id="valuesList">
                </ul>
            </div>
            <button type="button" class="btn btn-primary" style="visibility:visible" onclick="deleteEntity()" id="btnDelete">Delete this entity</button>
            <p id="message" class="text-danger"></p>
        </div>
    </div>

    <script>
        var timeout;
        var entityData;
        
        function myAlert(text) {
            clearTimeout(timeout);
            document.getElementById("message").textContent = text;

            timeout = setTimeout(function () {
                document.getElementById("message").textContent = null;
            }, 5000)
        }

        function startValuesEntity() {
            var http = new XMLHttpRequest();
            http.onreadystatechange = function () {
                if (http.readyState == 4) {
                    if (http.status < 400) {
                        entityData = JSON.parse(http.responseText);
                        document.getElementById("id").innerText = entityData.Id;
                        populateValues(entityData.Values);
                    } else {
                        myAlert(http.statusText);
                    }
                }
            };
            http.open("POST", "/api/values/");
            http.setRequestHeader("Content-Type", "application/json");
            http.send(id.toString());
        }

        function refreshEntity() {
            if (!entityData) return;
            var http = new XMLHttpRequest();
            http.onreadystatechange = function () {
                if (http.readyState == 4) {
                    if (http.status < 400) {
                        entityData = JSON.parse(http.responseText);
                        populateValues(entityData.Values);
                    } else {
                        myAlert(http.statusText);
                    }
                }
            };
            http.open("GET", "/api/values/" + entityData.Id + "?randomAvoidCache=" + Math.random());
            http.send();

            document.getElementById("newValueContent").value = '';
        }

        function populateValues(values) {
            if (!values) return;
            var list = document.getElementById('valuesList');
            while (list.firstChild) {
                list.removeChild(list.firstChild);
            }
            for (var i = 0; i < values.length; i++) {
                var item = document.createElement('li');
                item.appendChild(document.createTextNode(values[i]));
                item.className = 'list-group-item';
                list.appendChild(item);
            }
        }

        function addNewValue() {
            if (!entityData) return;
            var content = document.getElementById("newValueContent").value;
            if (!content) return;
            var id = 'id' + Math.floor(1 + Math.random() * 0x7FFFFFFF);
            if (!entityData.Values) {
                entityData.Values = [content];
            } else {
                entityData.Values.push(content);
            }
            var http = new XMLHttpRequest();
            http.onreadystatechange = function () {
                if (http.readyState == 4) {
                    if (http.status < 400) {
                        myAlert('item added.');
                        refreshEntity();
                    } else {
                        myAlert(http.statusText);
                    }
                }
            }
            http.open("PUT", "/api/values/" + entityData.Id);
            http.setRequestHeader("Content-Type", "application/json");
            http.send(JSON.stringify(entityData));
        }

        function deleteEntity() {
            if (!entityData) return;
            var http = new XMLHttpRequest();
            http.onreadystatechange = function () {
                if (http.readyState == 4) {
                    if (http.status < 400) {
                        myAlert('entity deleted.');
                        startValuesEntity();
                    } else {
                        myAlert(http.statusText);
                    }
                }
            }
            http.open("DELETE", "/api/values/" + entityData.Id);
            http.send();
        }

    </script>
</body>

</html>